<!doctype html>
<html>
	<head>
		<title>What's the Color of the Sky in Berlin?</title>
		<meta charset="utf8">
		<meta name="viewport" content="width=device-width">
		<style>
			html, body {
				padding: 0;
				margin: 0;
				color: #333;
			}
			html {
				font-family: sans-serif;
				text-align: center;
				font-size: 12px;
				height: 100%;
			}
			body {
				background-repeat: no-repeat;
			 	background-position: center center;
				background-size: contain;
			}
			a {
				color: inherit;
			}
			h1 {
				font-size: 15px;
			}
			strong {
				font-size: 55px;
				display: block;
				position: fixed;
				top: 50%;
				margin-top: -80px;
				width: 100%;
			}
			footer {
				position: fixed;
				left: 0;
				bottom: 0;
				width: 100%;
				opacity: .5;
			}
		</style>
		<script>
			var yql = 'http://query.yahooapis.com/v1/public/yql?format=json&callback=imageLoaded&q=',
				query = 'select * from data.uri where url="http://www.met.fu-berlin.de/wetter/webcam/Cam00_prev.jpg"',
				img = new Image,
				canvas = document.createElement("canvas"),
				head = document.querySelector('head'),
				favicon;

			function init() {
				loadImage();
			}

			function loadImage() {
				var script = document.createElement('script');
				script.src = yql + encodeURIComponent(query);
				head.appendChild(script);
			}

			function imageLoaded(response) {
				img.src = response.query.results.url;
			}

			function setFavicon(color) {
				if(! favicon) {
					favicon = document.createElement('link');
					favicon.type = 'image/x-icon';
					favicon.rel = 'icon';
					head.appendChild(favicon);
				}
				var canvas = document.createElement('canvas'),
						ctx;
				if (canvas.getContext) {
					canvas.height = canvas.width = 16; // set the size
					ctx = canvas.getContext('2d');
					ctx.fillStyle = 'rgb(' + color.join(',') + ')';
					ctx.fillRect(0, 0, 16, 16);
					favicon.href = canvas.toDataURL('image/png');
				}
			}

			function setBackgroundImage(color) {
				var svg = document.getElementById('svg');
				document.body.style.backgroundImage = 'url("data:image/svg+xml;utf8,'
					+ encodeURIComponent(svg.parentNode.innerHTML) + '")';
			}

			img.onload = function() {
				var color = getSkyColor(img, canvas);

				// show color
				document.body.style.backgroundColor = 'rgb(' + color.join(',') + ')';
				document.body.style.color = 'rgb(' + color.map(function(c) { return 255 - c; }).join(',') + ')';
				var target = document.getElementById('color');
				target.innerHTML = '#' + hex(color)
					+ '<br>' + findNearest(color);

				// update favicon
				setFavicon(color);

				setBackgroundImage(color);
			}
		</script>
	</head>
	<body title="Yeah, that's the color of it...">
		<header>
			<h1>What's the Color of the Sky in Berlin?</h1>
		</header>
		<strong id="color">Loading...</strong>
		<footer>
			<p>
				Brought to you by <a href="http://twitter.com/salomvary" target="_blank">@salomvary</a> â€¢
				data source <a href="http://www.met.fu-berlin.de/de/wetter/webcam/" target="_blank">Met FU Berlin</a>
			</p>
		</footer>
		<div style="display:none">
			<svg width="50" height="500" version="1.1"
			xmlns="http://www.w3.org/2000/svg" id="svg" fill="#fff">
				<g opacity="0.2">
					<polygon points="25,0 40,500 10,500"/>
					<circle r="25" cx="25" cy="190"/>
				</g>
			</svg>
		</div>
		<script src="colors.js"></script>
		<script>init();</script>
	</body>
</html>
